<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Arcana — Feed</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;600&family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />
    <meta name="color-scheme" content="dark">
</head>
<body>

<!-- Background layers -->
<div class="sky sky--back"></div>
<div class="sky sky--mid"></div>
<div class="sky sky--front"></div>
<div class="sky-belt"></div>
<div id="spotlight"></div>
<div class="shooting shooting--a"></div>
<div class="shooting shooting--b"></div>
<div class="shooting shooting--c"></div>

<!-- Header: Back only (no brand) -->
<header class="topbar page">
    <button class="back-btn" aria-label="Go back"
            onclick="(history.length>1)?history.back():location.href='index.html'">
        <span class="back-glyph" aria-hidden="true">↶</span>
        <span class="back-text">Back</span>
    </button>
</header>

<main class="wrap">
    <h1 class="page-title">Feed</h1>
    <p class="page-sub">Leave a trace beneath the stars.</p>

    <!-- Post form (styled by .form / .input / .textarea / .btn classes) -->
    <form id="post-form" class="form" autocomplete="off">
        <div class="form-row">
            <label for="name">Name</label>
            <input id="name" class="input" type="text" maxlength="40" placeholder="Who speaks?">
        </div>
        <div class="form-row">
            <label for="message">Message</label>
            <textarea id="message" class="textarea" maxlength="800" placeholder="Share a thought, a link, a spark…"></textarea>
        </div>
        <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="post-btn">Post →</button>
            <span class="form-note">Be kind. No edits, no deletes.</span>
        </div>
        <p id="post-status" class="form-note"></p>
    </form>

    <h3 class="page-sub" style="margin-top:18px">Latest posts</h3>
    <ul id="feed" class="feed"></ul>
</main>

<footer class="footer">
    <p>© 2025 Basit Azizi — All Rights Reserved</p>
</footer>

<!-- Music on this page -->
<script src="https://elfsightcdn.com/platform.js" async></script>
<div class="elfsight-app-60f17d6b-900b-4e2a-bcc6-1d637566d46c" data-elfsight-app-lazy></div>

<!-- Spotlight follow -->
<script>
    const spot = document.getElementById('spotlight');
    function moveSpot(x,y){ spot.style.setProperty('--x', x + 'px'); spot.style.setProperty('--y', y + 'px'); }
    window.addEventListener('mousemove', e => moveSpot(e.clientX, e.clientY));
    window.addEventListener('touchmove', e => { const t=e.touches[0]; if(t) moveSpot(t.clientX, t.clientY); }, {passive:true});
</script>

<!-- Feed logic (Firebase v12) -->
<script type="module">
    // Use the same config.js you created (DO NOT commit that file)
    import { firebaseConfig } from './config.js';

    import { initializeApp, getApp, getApps } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js';
    import {
        getFirestore, collection, addDoc, serverTimestamp,
        onSnapshot, query, orderBy
    } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js';

    // init (don’t double-init if already done elsewhere)
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // helpers
    const $ = s => document.querySelector(s);
    const esc = s => (s ?? '').toString()
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;').replace(/'/g,'&#039;');

    const nameEl = $('#name');
    const msgEl  = $('#message');
    const btnEl  = $('#post-btn');
    const status = $('#post-status');
    const listEl = $('#feed');

    // submit
    $('#post-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = nameEl.value.trim() || 'Anonymous';
        const text = msgEl.value.trim();

        if(!text){ status.textContent = "Write something first."; return; }

        btnEl.disabled = true;
        status.textContent = "Posting…";

        try{
            await addDoc(collection(db, 'posts'), {
                name, text,
                createdAt: serverTimestamp()
            });
            msgEl.value = '';
            status.textContent = "Posted ✓";
            setTimeout(()=> status.textContent = "", 1200);
        } catch(err){
            status.textContent = "Could not post. Check rules/API key.";
            console.error(err);
        } finally{
            btnEl.disabled = false;
        }
    });

    // live feed
    const q = query(collection(db, 'posts'), orderBy('createdAt', 'desc'));
    onSnapshot(q, (snap) => {
        const items = [];
        snap.forEach(doc => {
            const d = doc.data();
            const when = d.createdAt?.toDate ? d.createdAt.toDate() : null;
            const time = when ? when.toLocaleString() : '…';
            items.push(`
          <li class="post">
            <div class="post-head">
              <span class="post-name">${esc(d.name || 'Anonymous')}</span>
              <span class="post-time">${esc(time)}</span>
            </div>
            <div class="post-body">${esc(d.text || '')}</div>
          </li>
        `);
        });
        listEl.innerHTML = items.join('') || `<li class="post"><div class="post-body">Be first to write under the stars.</div></li>`;
    });
</script>
</body>
</html>
